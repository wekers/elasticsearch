<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <title>RabbitMQ Live Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <style>
        :root {
            --bg: #1e2328;
            --panel: #2b3137;
            --text: #e6edf3;
            --muted: #9aa4af;
            --ok: #0ea5e9;
            --warn: #f59e0b;
            --bad: #ef4444;
            --card: #111418;
            --btn: #2d333b;
            --btn-hover: #3a424b;
            --live-indicator: #10b981;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 24px;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
            background: var(--bg);
            color: var(--text);
        }

        .container { max-width: 1100px; margin: 0 auto; display: grid; gap: 16px; }

        .title {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--live-indicator);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--live-indicator);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        .section {
            background: var(--panel);
            border-radius: 10px;
            padding: 12px 14px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .section h2 {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: .4px;
            text-transform: uppercase;
            opacity: .9;
            margin: 0;
        }

        .queue-name {
            background: #4b5563;
            color: #fff;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            flex-grow: 1;
        }

        .queue-name.created { background: #0ea5e9; }
        .queue-name.updated { background: #6366f1; }
        .queue-name.deleted { background: #f59e0b; color: #1e2328; }
        .queue-name.retry { background: #059669; }
        .queue-name.dead { background: #ef4444; }

        .message-count {
            background: #374151;
            color: #fff;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .message-count.high { background: #dc2626; }
        .message-count.medium { background: #d97706; }
        .message-count.low { background: #059669; }

        .msg-card {
            background: var(--card);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #2b3137;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: ui-monospace, monospace;
            font-size: 12px;
            background: #0b0f14;
            color: #e5e7eb;
            padding: 10px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .btn {
            border: 0;
            background: var(--btn);
            color: var(--text);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover { background: var(--btn-hover); }
        .btn.ok { background: var(--ok); }
        .btn.ok:hover { background: #0284c7; }
        .btn.danger { background: var(--bad); }
        .btn.danger:hover { background: #dc2626; }

        .empty {
            color: var(--muted);
            font-size: 13px;
            margin: 6px 0 12px;
            text-align: center;
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .control-btn {
            background: #374151;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .control-btn:hover { background: #4b5563; }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>

<body>

<div class="container">
    <div class="title">
        üêá RabbitMQ Dashboard
        <div class="live-indicator">
            <div class="live-dot"></div><span>LIVE</span>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button class="control-btn" onclick="refreshAll()">üîÑ Atualizar Agora</button>

        <div class="auto-refresh">
            <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
            <label for="autoRefresh">Atualiza√ß√£o autom√°tica (5s)</label>
        </div>

        <div style="color: var(--muted); font-size: 13px;">
            √öltima atualiza√ß√£o: <span id="lastUpdate">-</span>
        </div>
    </div>

    <!-- CREATED -->
    <section class="section" id="createdSection">
        <div class="section-header">
            <h2>Created Queue</h2>
            <div class="message-count" id="createdCount">0</div>
        </div>
        <div class="queue-name created" th:text="${createdQueue}">products.created.queue</div>
        <div id="createdMessages"></div>
    </section>

    <!-- UPDATED -->
    <section class="section" id="updatedSection">
        <div class="section-header">
            <h2>Updated Queue</h2>
            <div class="message-count" id="updatedCount">0</div>
        </div>
        <div class="queue-name updated" th:text="${updatedQueue}">products.updated.queue</div>
        <div id="updatedMessages"></div>
    </section>

    <!-- DELETED -->
    <section class="section" id="deletedSection">
        <div class="section-header">
            <h2>Deleted Queue</h2>
            <div class="message-count" id="deletedCount">0</div>
        </div>
        <div class="queue-name deleted" th:text="${deletedQueue}">products.deleted.queue</div>
        <div id="deletedMessages"></div>
    </section>

    <!-- RETRY -->
    <section class="section" id="retrySection">
        <div class="section-header">
            <h2>Retry Queue</h2>
            <div class="message-count" id="retryCount">0</div>
        </div>
        <div class="queue-name retry" th:text="${retryQueue}">products.retry.5s.queue</div>
        <div id="retryMessages"></div>
    </section>

    <!-- DEAD LETTER -->
    <section class="section" id="deadSection">
        <div class="section-header">
            <h2>Dead Letter Queue</h2>
            <div class="message-count" id="deadCount">0</div>
        </div>
        <div class="queue-name dead" th:text="${deadQueue}">products.dead.queue</div>
        <div id="deadMessages"></div>
    </section>

</div>

<script>
    let autoRefreshInterval = null;
    const AUTO_REFRESH_INTERVAL = 5000;

    document.addEventListener('DOMContentLoaded', function () {
        refreshAll();
        startAutoRefresh();
    });

    let lastSnapshot = {
        created: '',
        updated: '',
        deleted: '',
        retry: '',
        dead: ''
    };

    async function refreshAll() {
        try {
            const res = await fetch('/queues/api/all-messages');
            const data = await res.json();

            updateQueueSection('created', data.createdMessages, data.createdCount);
            updateQueueSection('updated', data.updatedMessages, data.updatedCount);
            updateQueueSection('deleted', data.deletedMessages, data.deletedCount);
            updateQueueSection('retry', data.retryMessages, data.retryCount);
            updateQueueSection('dead', data.deadMessages, data.deadCount);

            updateLastUpdateTime();
        } catch (error) {
            console.error("Erro:", error);
        }
    }

    function updateQueueSection(queue, messages, count) {
        const container = document.getElementById(`${queue}Messages`);
        const counter = document.getElementById(`${queue}Count`);

        counter.textContent = count;
        updateCountStyle(counter, count);

        const snapshot = JSON.stringify(messages);
        if (lastSnapshot[queue] === snapshot) return;

        lastSnapshot[queue] = snapshot;
        container.innerHTML = '';

        if (!messages || messages.length === 0) {
            container.innerHTML = '<div class="empty">Sem mensagens.</div>';
            return;
        }

        messages.forEach(m => container.appendChild(createMessageCard(m, queue)));
    }

    function updateCountStyle(el, count) {
        el.classList.remove("high", "medium", "low");
        if (count > 10) el.classList.add("high");
        else if (count > 5) el.classList.add("medium");
        else if (count > 0) el.classList.add("low");
    }

    function createMessageCard(message, queue) {
        const card = document.createElement('div');
        card.className = 'msg-card';

        const pre = document.createElement('pre');
        pre.className = 'msg-pre';
        pre.textContent = message;

        const actions = document.createElement('div');
        actions.className = 'actions';

        // REPROCESS
        const form = document.createElement('form');
        form.action = '/queues/reprocess';
        form.method = 'post';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'body';
        input.value = message;

        const btn = document.createElement('button');
        btn.className = 'btn ok';
        btn.type = 'submit';
        btn.textContent = '‚ü≥ Reprocessar';

        form.appendChild(input);
        form.appendChild(btn);
        actions.appendChild(form);

        // DELETE FIRST (only for DLQ)
        if (queue === 'dead') {
            const delForm = document.createElement('form');
            delForm.action = '/queues/delete';
            delForm.method = 'post';
            const delBtn = document.createElement('button');
            delBtn.type = 'submit';
            delBtn.className = 'btn danger';
            delBtn.textContent = 'üóë Excluir (1¬™ msg)';
            delForm.appendChild(delBtn);

            // only add to first card
            if (document.getElementById(`${queue}Messages`).children.length === 0) {
                actions.appendChild(delForm);
            }
        }

        card.appendChild(pre);
        card.appendChild(actions);

        return card;
    }

    function updateLastUpdateTime() {
        document.getElementById('lastUpdate').textContent =
            new Date().toLocaleTimeString('pt-BR');
    }

    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(refreshAll, AUTO_REFRESH_INTERVAL);
    }

    function toggleAutoRefresh() {
        const chk = document.getElementById("autoRefresh");
        if (chk.checked) startAutoRefresh();
        else clearInterval(autoRefreshInterval);
    }
</script>

</body>
</html>
