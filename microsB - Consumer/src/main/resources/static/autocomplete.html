<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Cat√°logo ‚Äì Busca com Autocomplete</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        :root {
            --bg: #111827;
            --card: #020617;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.12);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: #1f2933;
            --danger: #f97373;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background:
                    radial-gradient(circle at 15% 15%, #1f2937 0, transparent 50%),
                    radial-gradient(circle at 85% 85%, #111827 0, transparent 55%),
                    #020617;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text);
            padding: 16px;
        }

        .shell {
            width: 100%;
            max-width: 640px;
            background: linear-gradient(145deg, #020617, #020617);
            border-radius: 18px;
            padding: 22px 22px 18px;
            position: relative;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        .shell::before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(56, 189, 248, .42), transparent 60%);
            opacity: 0.15;
            pointer-events: none;
            z-index: -1;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 14px;
        }

        .title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .title-main {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: .02em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .title-main span.icon {
            font-size: 18px;
        }

        .title-sub {
            font-size: 12px;
            color: var(--muted);
        }

        .pill {
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(15, 23, 42, 0.85);
            color: var(--muted);
        }

        .pill-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, .25);
            animation: pulse 1.8s infinite ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.25); opacity: .4; }
            100% { transform: scale(1); opacity: 1; }
        }

        .search-wrap {
            position: relative;
            margin-bottom: 6px;
        }

        .search-input {
            width: 100%;
            padding: 11px 40px 11px 38px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: radial-gradient(circle at 0 0, rgba(56, 189, 248, .10), transparent 55%),
            rgba(15, 23, 42, 0.95);
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
        }

        .search-input::placeholder {
            color: rgba(148, 163, 184, 0.9);
        }

        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
            background: radial-gradient(circle at 0 0, rgba(56, 189, 248, .12), transparent 55%),
            rgba(15, 23, 42, 0.98);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            opacity: .85;
            pointer-events: none;
        }

        .kbd-hint {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: .8;
        }

        .kbd {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid rgba(148, 163, 184, .7);
            color: var(--muted);
            background: rgba(15, 23, 42, .9);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--muted);
            padding: 2px 4px 0;
        }

        .status-left span {
            opacity: .85;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-chip {
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(31, 41, 55, 0.9);
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
            animation: loadingPulse 1s infinite ease-in-out;
        }

        @keyframes loadingPulse {
            0%, 100% { transform: scale(.7); opacity: .4; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .suggestions {
            margin-top: 8px;
            background: var(--card);
            border-radius: 14px;
            border: 1px solid var(--border);
            max-height: 280px;
            overflow-y: auto;
            padding: 4px 0;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
        }

        .suggestions.hidden {
            display: none;
        }

        .suggest-item {
            padding: 8px 12px;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background .12s ease;
            border-radius: 8px;
            margin: 0 6px;
        }

        .suggest-item + .suggest-item {
            margin-top: 4px;
        }

        .suggest-item:hover,
        .suggest-item.active {
            background: var(--accent-soft);
        }

        .suggest-primary {
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
        }

        .suggest-highlight mark {
            background: none;
            color: var(--accent);
            font-weight: 500;
        }

        .suggest-sub {
            margin-top: 2px;
            font-size: 11px;
            color: var(--muted);
        }

        .empty-state {
            padding: 10px 14px;
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }

        .badge {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .7);
            color: var(--muted);
            white-space: nowrap;
        }

        @media (max-width: 480px) {
            .shell {
                padding: 18px 16px 14px;
            }

            .title-main {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
<div class="shell">
    <header class="header">
        <div class="title">
            <div class="title-main">
                <span class="icon">üîç</span>
                <span>Busca inteligente de produtos</span>
            </div>
            <div class="title-sub">
                Digite parte do nome, marca ou modelo ‚Äì o autocomplete se adapta.
            </div>
        </div>
        <div class="pill">
            <span class="pill-dot"></span>
            <span>powered by Elasticsearch</span>
        </div>
    </header>

    <div class="search-wrap">
        <span class="search-icon">‚åï</span>
        <input
                id="q"
                class="search-input"
                placeholder="Ex.: ‚Äúdell 4060‚Äù, ‚Äússd 1tb‚Äù, ‚Äúmonitor 27‚Äù, ‚Äúteclado mec√¢nico‚Äù"
                autocomplete="off"
        />
        <div class="kbd-hint">
            <span class="kbd">‚Üë</span>
            <span class="kbd">‚Üì</span>
            <span class="kbd">‚èé</span>
        </div>
    </div>

    <div class="status-row">
        <div class="status-left">
            <span id="statusText">Digite pelo menos 2 caracteres‚Ä¶</span>
        </div>
        <div class="status-right">
            <div id="loadingDot" class="loading-dot" style="visibility:hidden;"></div>
            <div class="status-chip">
                <span id="resultsCount">0</span> sugest√µes
            </div>
        </div>
    </div>

    <div id="suggestions" class="suggestions hidden"></div>
</div>

<script>
    const API_BASE = 'http://localhost:8081'; // ajuste se o Microservi√ßo B estiver em outro host/porta

    const inputEl = document.getElementById('q');
    const suggestionsEl = document.getElementById('suggestions');
    const statusTextEl = document.getElementById('statusText');
    const loadingDotEl = document.getElementById('loadingDot');
    const resultsCountEl = document.getElementById('resultsCount');

    const MIN_CHARS = 2;
    const DEBOUNCE_MS = 220;

    let debounceTimer = null;
    let controller = null;
    let currentSuggestions = [];
    let activeIndex = -1;

    function setLoading(isLoading) {
        loadingDotEl.style.visibility = isLoading ? 'visible' : 'hidden';
    }

    function clearSuggestions() {
        currentSuggestions = [];
        activeIndex = -1;
        suggestionsEl.innerHTML = '';
        suggestionsEl.classList.add('hidden');
        resultsCountEl.textContent = '0';
    }

    function highlightMatch(text, term) {
        if (!term) return text;
        const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(safeTerm, 'i');
        const match = text.match(regex);
        if (!match) return text;
        const start = match.index;
        const end = start + match[0].length;
        return (
            text.slice(0, start) +
            '<mark>' + text.slice(start, end) + '</mark>' +
            text.slice(end)
        );
    }

    function renderSuggestions(term, items) {
        suggestionsEl.innerHTML = '';
        currentSuggestions = items;
        activeIndex = -1;
        resultsCountEl.textContent = String(items.length);

        if (!items.length) {
            suggestionsEl.innerHTML =
                '<div class="empty-state">Nenhuma sugest√£o encontrada. Tente outro termo ou revise a grafia.</div>';
            suggestionsEl.classList.remove('hidden');
            return;
        }

        items.forEach((name, idx) => {
            const div = document.createElement('div');
            div.className = 'suggest-item';
            div.dataset.index = String(idx);

            const primary = document.createElement('div');
            primary.className = 'suggest-primary';

            const left = document.createElement('div');
            left.className = 'suggest-highlight';
            left.innerHTML = highlightMatch(name, term);

            const right = document.createElement('span');
            right.className = 'badge';
            right.textContent = 'Enter ‚Üí abrir resultados';

            primary.appendChild(left);
            primary.appendChild(right);

            const sub = document.createElement('div');
            sub.className = 'suggest-sub';
            sub.textContent = 'Buscar por "' + name + '" no cat√°logo';

            div.appendChild(primary);
            div.appendChild(sub);

            div.addEventListener('mousedown', (e) => {
                e.preventDefault(); // evitar perder foco e disparar blur
                selectSuggestion(idx);
            });

            suggestionsEl.appendChild(div);
        });

        suggestionsEl.classList.remove('hidden');
    }

    function setActive(index) {
        const items = suggestionsEl.querySelectorAll('.suggest-item');
        items.forEach(i => i.classList.remove('active'));

        if (index >= 0 && index < items.length) {
            items[index].classList.add('active');
            activeIndex = index;

            // scroll into view se necess√°rio
            const el = items[index];
            const rect = el.getBoundingClientRect();
            const parentRect = suggestionsEl.getBoundingClientRect();
            if (rect.top < parentRect.top) {
                el.scrollIntoView({ block: 'nearest' });
            } else if (rect.bottom > parentRect.bottom) {
                el.scrollIntoView({ block: 'nearest' });
            }
        } else {
            activeIndex = -1;
        }
    }

    function selectSuggestion(index) {
        if (index < 0 || index >= currentSuggestions.length) return;
        const value = currentSuggestions[index];
        inputEl.value = value;
        openSearch(value);
    }

    function openSearch(term) {
        if (!term || !term.trim()) return;
        const url = `${API_BASE}/catalogo/search?query=${encodeURIComponent(term.trim())}`;
        window.open(url, '_blank');
    }

    async function fetchSuggestions(term) {
        if (controller) controller.abort();
        controller = new AbortController();

        try {
            setLoading(true);
            statusTextEl.textContent = 'Consultando sugest√µes‚Ä¶';

            const res = await fetch(
                `${API_BASE}/catalogo/suggest?prefix=${encodeURIComponent(term)}`,
                { signal: controller.signal }
            );

            if (!res.ok) {
                throw new Error('HTTP ' + res.status);
            }

            const data = await res.json();
            const list = Array.isArray(data) ? data : [];

            if (!list.length) {
                statusTextEl.textContent = 'Nenhum match direto ‚Äî o motor tenta se adaptar.';
            } else {
                statusTextEl.textContent = `Sugest√µes encontradas para ‚Äú${term}‚Äù`;
            }

            renderSuggestions(term, list);
        } catch (err) {
            if (err.name === 'AbortError') return;
            console.error('Erro no autocomplete:', err);
            statusTextEl.textContent = 'Erro ao buscar sugest√µes. Tente novamente.';
            clearSuggestions();
        } finally {
            setLoading(false);
        }
    }

    inputEl.addEventListener('input', () => {
        const term = inputEl.value.trim();

        if (debounceTimer) clearTimeout(debounceTimer);
        if (!term || term.length < MIN_CHARS) {
            statusTextEl.textContent = 'Digite pelo menos 2 caracteres‚Ä¶';
            clearSuggestions();
            return;
        }

        debounceTimer = setTimeout(() => {
            fetchSuggestions(term);
        }, DEBOUNCE_MS);
    });

    inputEl.addEventListener('keydown', (e) => {
        const hasSuggestions = currentSuggestions.length > 0;

        if (e.key === 'ArrowDown' && hasSuggestions) {
            e.preventDefault();
            const next = activeIndex + 1 >= currentSuggestions.length ? 0 : activeIndex + 1;
            setActive(next);
        } else if (e.key === 'ArrowUp' && hasSuggestions) {
            e.preventDefault();
            const prev = activeIndex - 1 < 0 ? currentSuggestions.length - 1 : activeIndex - 1;
            setActive(prev);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIndex >= 0 && hasSuggestions) {
                selectSuggestion(activeIndex);
            } else {
                openSearch(inputEl.value);
            }
        } else if (e.key === 'Escape') {
            clearSuggestions();
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.shell')) {
            clearSuggestions();
        }
    });
</script>
</body>
</html>
