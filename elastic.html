<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Autocomplete simples</title>
  <style>
    .wrap { max-width: 480px; margin: 2rem auto; position: relative; }
    input { width: 100%; padding: 12px 14px; font-size: 16px; }
    ul { position:absolute; left:0; right:0; top:44px; background:#fff; border:1px solid #ddd; border-top:none; margin:0; padding:0; list-style:none; max-height:260px; overflow-y:auto; }
    li { padding:10px 12px; cursor:pointer; }
    .loading { position:absolute; top:12px; right:12px; opacity:.6; font: 12px sans-serif; }
  </style>
</head>
<body>
  <div class="wrap">
    <input id="q" placeholder="Buscar produtos…" />
    <div id="loading" class="loading" hidden>carregando…</div>
    <ul id="list"></ul>
  </div>

  <script>
    const API_BASE = 'http://localhost:8081'; // ajuste se precisar
    const q = document.getElementById('q');
    const list = document.getElementById('list');
    const loading = document.getElementById('loading');
    let timer, ctrl;

    function render(items = []) {
      list.innerHTML = '';
      items.forEach((s) => {
        const li = document.createElement('li');
        li.textContent = s;
        li.onmousedown = () => {
          window.open(`${API_BASE}/catalogo/search?query=${encodeURIComponent(s)}`, '_blank');
        };
        list.appendChild(li);
      });
    }

    q.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        window.open(`${API_BASE}/catalogo/search?query=${encodeURIComponent(q.value)}`, '_blank');
      }
    });

    q.addEventListener('input', () => {
      const term = q.value.trim();
      if (timer) clearTimeout(timer);
      if (ctrl) ctrl.abort();
      if (term.length < 2) { render([]); loading.hidden = true; return; }

      timer = setTimeout(async () => {
        try {
          ctrl = new AbortController();
          loading.hidden = false;
          const res = await fetch(`${API_BASE}/catalogo/suggest?prefix=${encodeURIComponent(term)}`, { signal: ctrl.signal });
          const data = res.ok ? await res.json() : [];
          render(Array.isArray(data) ? data : []);
        } catch (_) {
          render([]);
        } finally {
          loading.hidden = true;
        }
      }, 250);
    });
  </script>
</body>
</html>
